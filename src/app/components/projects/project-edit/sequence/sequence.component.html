<div class="py-4">
  <!-- Header -->
  <div class="flex items-center justify-between p-4 border-b">
    <h2 class="text-lg font-semibold">{{ 'project.sequence' | translate }}</h2>
    
    <span *ngIf="hasUnsavedChanges" class="text-sm text-tertiary">
      {{ 'project.unsaved.changes' | translate }}
    </span>
  </div>

  <div class="lg:flex lg:gap-6 pt-6">
    <div class="lg:flex-shrink-0 mb-6 lg:mb-0 lg:sticky lg:top-6 lg:self-start lg:h-fit">
      <div class="flex flex-wrap gap-2 lg:flex-col lg:gap-3 lg:w-24">
        <button 
          class="flex flex-col items-center gap-2 p-3 rounded-lg min-w-[60] lg:min-w-0 lg:w-full lg:justify-center hover:bg-primary hover:text-white  transition-colors"
          (click)="addCue('audio')">
          <app-icon icon="audio" class="w-8 h-8"></app-icon>
          <span class="text-xs lg:text-sm">{{ 'project.cue.audio' | translate }}</span>
        </button>
        
        <button 
          class="flex flex-col items-center gap-2 p-3 rounded-lg min-w-[60] lg:min-w-0 lg:w-full lg:justify-center hover:bg-primary hover:text-white transition-colors"
          (click)="addCue('video')">
          <app-icon icon="video" class="w-8 h-8"></app-icon>
          <span class="text-xs lg:text-sm">{{ 'project.cue.video' | translate }}</span>
        </button>
        
        <button class="flex flex-col items-center gap-2 p-3 rounded-lg min-w-[60] lg:min-w-0 lg:w-full lg:justify-center hover:bg-primary hover:text-white transition-colors"
          (click)="addCue('dmx')">
          <app-icon icon="light" class="w-8 h-8"></app-icon>
          <span class="text-xs lg:text-sm">{{ 'project.cue.dmx' | translate }}</span>
        </button> 

        <button class="flex flex-col items-center gap-2 p-3 rounded-lg min-w-[60] lg:min-w-0 lg:w-full lg:justify-center hover:bg-primary hover:text-white transition-colors"
          (click)="addCue('action')">
          <app-icon icon="action" class="w-8 h-8"></app-icon>
          <span class="text-xs lg:text-sm">{{ 'project.cue.action' | translate }}</span>
        </button>       
        
        <div class="border-t border-gray-300 my-2"></div>
        
        <button 
          class="flex flex-col items-center gap-2 p-3 rounded-lg min-w-[60] lg:min-w-0 lg:w-full lg:justify-center transition-colors border-2"
          [class.border-tertiary]="hasProjectChanges"
          [class.text-tertiary]="hasProjectChanges"
          [class.border-gray-300]="!hasProjectChanges"
          [class.text-gray-400]="!hasProjectChanges"
          [class.cursor-not-allowed]="!hasProjectChanges"
          [class.cursor-pointer]="hasProjectChanges"
          [disabled]="!hasProjectChanges"
          (click)="saveProject()">
          <app-icon icon="save" class="w-8 h-8"></app-icon>
          <span class="text-xs lg:text-sm">{{ 'project.cue.save' | translate }}</span>
        </button>
      </div>
    </div>

    <div class="flex-1 relative overflow-hidden">
      <div class="rounded-lg shadow-sm transition-all duration-300 overflow-x-auto pb-32"
           [style.margin-right.px]="drawerService.isActivityDrawerOpen() ? DRAWER_WIDTH : 0">
        <table class="w-full">
            <thead>
              <tr>
                <th style="min-width: 28px;"><!-- icon warning --></th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider"><!-- order --></th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 80px;">{{ 'project.cue-table.type' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" 
                    [class.name-column-responsive]="!drawerService.isActivityDrawerOpen()"
                    [style.width]="drawerService.isActivityDrawerOpen() ? '80px' : null"
                    [style.min-width]="drawerService.isActivityDrawerOpen() ? '80px' : null"
                    [style.max-width]="drawerService.isActivityDrawerOpen() ? '80px' : null">{{ 'project.cue-table.name' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 120px;">{{ 'project.cue-table.prewait' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 120px;">{{ 'project.cue-table.duration' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 120px;">{{ 'project.cue-table.postwait' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 100px;">{{ 'project.cue-table.action' | translate }}</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="min-width: 180px;">{{ 'project.cue-table.controls' | translate }}</th>
              </tr>
            </thead>
            <tbody class="divide-y" cdkDropList (cdkDropListDropped)="onDrop($event)">
              <ng-container *ngFor="let cue of cues; let i = index">
                <tr class="hover:bg-opacity-50" cdkDrag [attr.data-cue-index]="i">
                  <td>
                    <app-icon 
                    *ngIf="shouldShowWarningIcon(cue)" 
                    icon="warning" 
                    class="text-red-500">
                  </app-icon>
                  </td>
                  <!-- Drag Handle -->
                  <td class="px-4 py-3">
                    <div class="cursor-move text-gray-400 hover:text-gray-600 flex items-center justify-center" cdkDragHandle>
                      <app-icon icon="points" class="w-[16px] h-[16px]"></app-icon>
                    </div>
                  </td>
                  
                  <td class="px-4 py-3">
                    <app-icon [icon]="cue.type" class="w-[16px] h-[16px]"></app-icon>
                  </td>
                  
              <td class="px-4 py-3 text-sm" 
                  [class.name-column-responsive]="!drawerService.isActivityDrawerOpen()"
                  [style.width]="drawerService.isActivityDrawerOpen() ? '80px' : null"
                  [style.min-width]="drawerService.isActivityDrawerOpen() ? '80px' : null"
                  [style.max-width]="drawerService.isActivityDrawerOpen() ? '80px' : null">
                <div class="table-name-cell">
                  <span>{{ cue.name }}</span>
                </div>
              </td>
                  
                  <td class="px-4 py-3 text-sm">
                    <div *ngIf="editingPrewait !== i; else prewaitInput" 
                         class="cursor-pointer hover:bg-dark-300 px-2 py-1 rounded transition-colors inline-block"
                         (click)="startEditPrewait(i, $event)">
                      {{ cue.prewait }}
                    </div>
                    <ng-template #prewaitInput>
                      <input 
                        type="text" 
                        class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                        style="width: 100px;"
                        [(ngModel)]="cue.prewait"
                        (click)="onInputClick($event)"
                        placeholder="00:00:00.000"
                        appTimecodeMask
                        autofocus>
                    </ng-template>
                  </td>
                  
                  <td class="px-4 py-3 text-sm">
                    {{ getCueData(cue.originalData)?.Media?.duration || '-' }}
                  </td>

                  <td class="px-4 py-3 text-sm">
                    <div *ngIf="editingPostwait !== i; else postwaitInput" 
                         class="cursor-pointer hover:bg-dark-300 px-2 py-1 rounded transition-colors inline-block"
                         (click)="startEditPostwait(i, $event)">
                      {{ cue.postwait }}
                    </div>
                    <ng-template #postwaitInput>
                      <input 
                        type="text" 
                        class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                        style="width: 100px;"
                        [(ngModel)]="cue.postwait"
                        (click)="onInputClick($event)"
                        placeholder="00:00:00.000"
                        appTimecodeMask
                        autofocus>
                    </ng-template>
                  </td>
                  
                  <td class="px-4 py-3">
                    <div class="relative" (click)="onDropdownClick($event)">
                      <button
                        class="flex items-center justify-center rounded transition-colors"
                        (click)="toggleActionDropdown(i, $event)"
                        [title]="getActionTypeLabel(cue.post_go)">
                        <app-icon [icon]="'post_go_' + cue.post_go" class="w-8 h-8"></app-icon>
                        <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div
                        *ngIf="openActionDropdown === i"
                        class="absolute top-full left-0 mt-1 bg-dark-100 border border-dark-300 rounded-lg shadow-lg z-50 min-w-48">
                        <div class="py-1">
                          <button
                            *ngFor="let option of actionTypeOptions"
                            class="w-full flex items-center px-4 py-2 text-sm hover:bg-dark-300 transition-colors"
                            [class.bg-dark-300]="cue.post_go === option.value"
                            (click)="selectActionType(i, option.value)">
                            <app-icon [icon]="option.icon" class="w-5 h-5 mr-3"></app-icon>
                            <span class="flex-1 text-left">{{ option.label }}</span>
                            <svg *ngIf="cue.post_go === option.value" class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                  
                  <!-- Controls -->
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <button 
                        class="text-xs py-1 px-2 border rounded" 
                        (click)="toggleTab(i, 'notes')"
                        [class.border-current]="cue.expanded && cue.activeTab === 'notes'"
                        [class.border-transparent]="!(cue.expanded && cue.activeTab === 'notes')">
                        {{ 'project.cue-table.notes' | translate }}
                      </button>
                      
                      <button 
                        class="text-xs py-1 px-2 border rounded" 
                        (click)="toggleTab(i, 'edit')"
                        [class.border-current]="cue.expanded && cue.activeTab === 'edit'"
                        [class.border-transparent]="!(cue.expanded && cue.activeTab === 'edit')">
                        {{ 'project.cue-table.edit' | translate }}
                      </button>
                      
                      <button 
                        class="p-1" 
                        (click)="deleteCue(i)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3,6 5,6 21,6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                
                <tr *ngIf="cue.expanded" class="bg-dark-200">
                  <td colspan="9" class="px-4 py-12">
                    <div class="rounded">
                      <!-- Tabs -->
                      <div class="flex mb-3 border-b-2 mb-12">
                        <button 
                          class="px-8 py-2 text-sm border-b-2 border-primary translate-y-[2px]"
                          [class.border-current]="cue.activeTab === 'edit'"
                          [class.border-transparent]="cue.activeTab !== 'edit'"
                          (click)="setActiveTab(i, 'edit')">
                          {{ 'project.cue-table.basic' | translate }}
                        </button>
                        <button 
                          class="px-8 py-2 text-sm border-b-2 border-primary translate-y-[2px]"
                          [class.border-current]="cue.activeTab === 'media'"
                          [class.border-transparent]="cue.activeTab !== 'media'"
                          (click)="setActiveTab(i, 'media')">
                          {{ 'project.cue-table.media' | translate }}
                        </button>                                         
                        <button 
                          class="px-8 py-2 text-sm border-b-2 border-primary translate-y-[2px]"
                          [class.border-current]="cue.activeTab === 'notes'"
                          [class.border-transparent]="cue.activeTab !== 'notes'"
                          (click)="setActiveTab(i, 'notes')">
                          {{ 'project.cue-table.notes' | translate }}
                        </button>
                      </div>
                      
                      <div *ngIf="cue.activeTab === 'edit'">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          <div class="field">
                            <label class="label">{{ 'project.cue-table.name' | translate }}</label>
                            <input 
                              type="text" 
                              class="input"
                              [(ngModel)]="cue.name"
                              (ngModelChange)="checkForChanges()">
                          </div>
                          
                          <div class="field">
                            <label class="label">{{ 'project.cue-table.prewait' | translate }}</label>
                            <input 
                              type="text" 
                              class="input"
                              [(ngModel)]="cue.prewait"
                              (ngModelChange)="checkForChanges()"
                              placeholder="00:00:00.000"
                              appTimecodeMask
                              title="Formato: HH:MM:SS.mmm (ejemplo: 00:01:30.500)">
                          </div>
                          
                          <div class="field">
                            <label class="label">{{ 'project.cue-table.postwait' | translate }}</label>
                            <input 
                              type="text" 
                              class="input"
                              [(ngModel)]="cue.postwait"
                              (ngModelChange)="checkForChanges()"
                              placeholder="00:00:00.000"
                              appTimecodeMask
                              title="Formato: HH:MM:SS.mmm (ejemplo: 00:01:30.500)">
                          </div>
                          
                          <div class="field">
                            <label class="label">{{ 'project.cue-table.action' | translate }}</label>
                            <select 
                              class="input"
                              [(ngModel)]="cue.post_go"
                              (ngModelChange)="checkForChanges()">
                                <option value="pause">{{ 'project.cue-table.action.pause' | translate }}</option>
                              <option value="go">{{ 'project.cue-table.action.continue' | translate }}</option>
                              <option value="go_at_end">{{ 'project.cue-table.action.follow' | translate }}</option>
                            </select>
                          </div>

                          <div class="field" *ngIf="cue.type !== 'dmx'">
                            <label class="label">{{ 'loop.type' | translate }}</label>
                            <div class="flex items-center justify-between">
                              <div class="flex items-center space-x-6 mt-3">
                                <label class="flex items-center">
                                  <input 
                                    type="radio" 
                                    name="loop_{{i}}" 
                                    value="inf"
                                    [(ngModel)]="cue.loop"
                                    (change)="onLoopTypeChange(cue)"
                                    class="radio mr-2">
                                  <span>{{ 'loop.infinite' | translate }}</span>
                                </label>
                                                                
                                <label class="flex items-center">
                                  <input 
                                    type="radio" 
                                    name="loop_{{i}}" 
                                    value="loop"
                                    [(ngModel)]="cue.loop"
                                    (change)="onLoopTypeChange(cue)"
                                    class="radio mr-2">
                                  <span>{{ 'loop.times' | translate }}</span>
                                </label>
                              </div>
                            </div>
                          </div> 
                          
                          <div *ngIf="cue.loop === 'loop' && cue.type !== 'dmx'" class="field">
                            <span class="label">{{ 'loop.number_times' | translate }}</span>
                            <input 
                              type="number" 
                              [(ngModel)]="cue.loop_times"
                              (ngModelChange)="checkForChanges()"
                              min="1"
                              class="input w-20">
                          </div>                          
                        </div>
                        
                        <div class="flex justify-end gap-2 mt-4">
                          <button class="px-3 py-1 text-sm rounded" (click)="collapseRow(i)">{{ 'close' | translate }}</button>
                        </div>
                      </div>

                      <!-- Media content -->
                      <div *ngIf="cue.activeTab === 'media'">
                        <!-- Solo mostrar para audio y video cues -->
                        <div *ngIf="cue.type === 'audio' || cue.type === 'video'" class="space-y-4">
                          <div class="field">
                            <label class="label">{{ cue.type === 'audio' ? ('media.select.audio.file' | translate) : ('media.select.video.file' | translate) }}</label>
                            <select 
                              class="input"
                              [value]="cue.selectedMediaFile?.uuid || ''"
                              (change)="onMediaFileSelectFromEvent(cue, $event)">
                              <option value="">{{ 'media.select.file.placeholder' | translate }}</option>
                              <option 
                                *ngFor="let mediaFile of getMediaFilesByType(cue.type)"
                                [value]="mediaFile.uuid"
                                [selected]="cue.selectedMediaFile?.uuid === mediaFile.uuid">
                                {{ mediaFile.file.name }}
                              </option>
                            </select>
                          </div>

                          <div *ngIf="cue.type === 'audio'" class="field">
                            <label class="label">Master Volume</label>
                            <input 
                            type="range" 
                            min="0" 
                            max="100" 
                            [value]="cue.master_vol"
                            (input)="onMasterVolumeChange(cue, +$any($event.target).value)"
                            class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer slider-thumb">

                            <p class="text-sm">{{ cue.master_vol }}%</p>
                          </div>
                          

                          <div class="field">
                            <label class="label">{{ 'media.select.outputs.label' | translate }}</label>
                            <app-multiselect
                            [options]="getMappingOptionsForCue(cue)"
                            [multiple]="true"
                            [placeholder]="getPlaceholderForCue(cue)"
                            [(ngModel)]="cue.selectedOutputs"
                            (selectionChange)="onOutputSelectionChange($event, cue)">
                          </app-multiselect>                            
                          </div>
                        </div>

                        <!-- DMX Cues - ConfiguraciÃ³n de canales -->
                        <div *ngIf="cue.type === 'dmx'" class="space-y-4">
                          <div class="field">
                            <label class="label">{{ 'dmx.universe' | translate }}</label>
                            <input 
                              type="number" 
                              class="input"
                              [ngModel]="cue.universe_num"
                              (ngModelChange)="onUniverseNumChange(cue, $event)"
                              min="0"
                              max="999">
                          </div>
                          <div class="field">
                            <label class="label">{{ 'dmx.fade.time' | translate }}</label>
                            <input 
                              type="number" 
                              class="input"
                              [ngModel]="cue.fade_in_time"
                              (ngModelChange)="onDmxFadeTimeChange(cue, $event)"
                              min="0"
                              step="0.1"
                              placeholder="0">
                          </div>
                          <div class="field">
                            <label class="label">{{ 'dmx.channels' | translate }}</label>
                            
                            <!-- Lista de canales DMX -->
                            <div class="space-y-3">
                              <div 
                                *ngFor="let channel of cue.dmx_channels; let channelIndex = index; trackBy: trackByChannelIndex"
                                class="flex items-center gap-3 p-3 bg-dark-300 rounded border">
                                
                                <div class="flex-1">
                                  <label class="block text-xs text-gray-400 mb-1">{{ 'dmx.channel.number' | translate }}</label>
                                  <input 
                                    type="number" 
                                    class="input w-full"
                                    [value]="channel.channel"
                                    (input)="onDmxChannelNumChange(cue, channelIndex, $event)"
                                    [class.border-red-500]="!isDmxChannelNumValid(cue, channel.channel, channelIndex)"
                                    min="1"
                                    max="512"
                                    placeholder="1">
                                  <div *ngIf="!isDmxChannelNumValid(cue, channel.channel, channelIndex)" 
                                       class="text-xs text-red-400 mt-1">
                                    {{ 'dmx.channel.duplicate.error' | translate }}
                                  </div>
                                </div>
                                
                                <div class="flex-2">
                                  <label class="block text-xs text-gray-400 mb-1">{{ 'dmx.channel.value' | translate }}</label>
                                  <div class="flex items-center gap-2">
                                    <input 
                                      type="range" 
                                      class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer slider"
                                      [value]="channel.value"
                                      (input)="onDmxChannelValueChange(cue, channelIndex, $event)"
                                      min="0"
                                      max="255"
                                      step="1">
                                    <span class="text-sm w-8 text-center">{{ channel.value }}</span>
                                  </div>
                                </div>
                                
                                <button 
                                  class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded transition-colors"
                                  (click)="removeDmxChannel(cue, channelIndex)"
                                  [disabled]="(cue.dmx_channels?.length || 0) <= 1"
                                  [class.opacity-50]="(cue.dmx_channels?.length || 0) <= 1"
                                  [class.cursor-not-allowed]="(cue.dmx_channels?.length || 0) <= 1">
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2h4a2 2 0 0 1 2 2v2"></path>
                                  </svg>
                                </button>
                              </div>
                            </div>
                            
                            <button 
                              class="mt-3 px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition-colors flex items-center gap-2"
                              (click)="addDmxChannel(cue)">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                              </svg>
                              {{ 'dmx.channel.add' | translate }}
                            </button>
                          </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-4">
                          <button class="px-3 py-1 text-sm rounded" (click)="collapseRow(i)">{{ 'close' | translate }}</button>
                        </div>
                      </div>                   

                      <!-- Notes content -->
                      <div *ngIf="cue.activeTab === 'notes'">
                        <textarea 
                          class="input" 
                          rows="3" 
                          placeholder="Add notes for this cue..."
                          [(ngModel)]="cue.notes"
                          (ngModelChange)="checkForChanges()">
                        </textarea>

                        <div class="flex justify-end gap-2 mt-2">
                          <button class="px-3 py-1 text-sm rounded" (click)="collapseRow(i)">{{ 'close' | translate }}</button>
                        </div>
                      </div>                  
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        
        <!-- Empty state -->
        <div *ngIf="!cues || cues.length === 0" class="text-center py-12">
          <div class="mb-2">
            <svg class="mx-auto w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          <p class="text-sm">{{ 'project.cue.empty' | translate }}</p>
          <p class="text-xs">{{ 'project.cue.empty.description' | translate }}</p>
        </div>
      </div>

      <app-activity-drawer></app-activity-drawer>
    </div>
  </div>
</div> 