<div class="bg-dark-300 relative w-full">
    <!-- Trigger Container -->
    <div
      class="relative w-full  border border-primary rounded-md pl-3 pr-10 py-2 cursor-pointer focus-within:outline-none focus-within:ring-1 focus-within:ring-primary focus-within:border-blue-500 hover:border-gray-400 transition-colors"
      [class.ring-1]="isOpen"
      [class.ring-blue-500]="isOpen"
      [class.border-blue-500]="isOpen"
      (click)="toggle()"
      [attr.aria-expanded]="isOpen"
      [attr.aria-haspopup]="true">
      
      <!-- Selected Tags (Multiple mode) -->
      <div *ngIf="multiple && selectedValues.length > 0" 
           class="flex flex-wrap gap-1 mb-1">
        <div *ngFor="let option of selectedOptions; trackBy: trackByValue"
             class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium  border border-primary">
          <span>{{ option?.label }}</span>
          <button
            type="button"
            class="ml-1 inline-flex items-center justify-center w-4 h-4 rounded-full focus:outline-none focus:bg-primary  transition-colors"
            (click)="removeSelectedOption(option?.value, $event)"
            [attr.aria-label]="'Quitar ' + option?.label">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Input/Display Text -->
      <div class="flex items-center">
        <span *ngIf="!multiple || selectedValues.length === 0" 
              class="block truncate"
              [class.text-gray-500]="selectedValues.length === 0">
          {{ displayText || placeholderText }}
        </span>

      </div>
      
      <!-- Arrow Icon -->
      <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
        <svg class="w-4 h-4 text-gray-300 transition-transform duration-200"
             [class.rotate-180]="isOpen"
             fill="none" 
             stroke="currentColor" 
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>
  
    <!-- Error state -->
    <div *ngIf="hasError" class="absolute inset-0 rounded-md border-2 border-red-500 pointer-events-none"></div>
  
    <!-- Clear all button (Multiple mode) -->
    <button *ngIf="multiple && selectedValues.length > 0"
            type="button"
            class="absolute right-8 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors z-10"
            (click)="clearAll($event)"
            aria-label="Limpiar todas las selecciones">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
  
  <!-- Dropdown Template -->
  <ng-template #dropdownTemplate>
    <div class="shadow-lg rounded-md bg-dark-300 border border-primary py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm max-h-80 flex flex-col"
         cdkTrapFocus
         [style.min-width.px]="triggerWidth"
         role="listbox"
         [attr.aria-multiselectable]="multiple">
      
      <!-- Search Input -->
      <div *ngIf="searchEnabled" class="px-3 py-2 border-b border-gray-600 flex-shrink-0">
        <div class="relative">
          <input
            #searchInput
            type="text"
            class="w-full pl-8 pr-3 py-2 border border-gray-600 rounded-md text-sm placeholder-gray-400 bg-dark-200 text-gray-100 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"
            placeholder="Buscar..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
            (keydown)="onSearchKeyDown($event)">
          
          <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <!-- Select/Deselect All (Multiple mode) -->
      <div *ngIf="multiple && filteredOptions.length > 0" 
           class="px-3 py-2 border-b border-gray-600 flex-shrink-0">
        <button
          type="button"
          class="w-full text-left text-sm text-gray-200 hover:text-primary focus:outline-none transition-colors"
          (click)="toggleSelectAll()">
          {{ allFilteredSelected ? 'Deseleccionar todo' : 'Seleccionar todo' }}
        </button>
      </div>
      
      <!-- Options Container -->
      <div class="flex-1 overflow-y-auto max-h-48">
        <!-- Options -->
        <div *ngFor="let option of filteredOptions; let i = index; trackBy: trackByValue"
             class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-dark-200 transition-colors text-gray-100"
             [class.bg-primary]="isSelected(option.value)"
             [class.text-white]="isSelected(option.value)"
             [class.bg-dark-200]="i === focusedIndex && !isSelected(option.value)"
             [class.opacity-50]="option.disabled"
             [class.cursor-not-allowed]="option.disabled"
             [attr.aria-selected]="isSelected(option.value)"
             [attr.aria-disabled]="option.disabled"
             role="option"
             (click)="selectOption(option)"
             (mouseenter)="focusedIndex = i">
          
          <div class="flex items-center">
            <!-- Checkbox for multiple -->
            <div *ngIf="multiple" class="flex items-center mr-3">
              <div class="w-4 h-4 border border-gray-400 rounded flex items-center justify-center transition-colors"
                   [class.bg-primary]="isSelected(option.value)"
                   [class.border-primary]="isSelected(option.value)"
                   [class.border-gray-600]="option.disabled">
                <svg *ngIf="isSelected(option.value)" 
                     class="w-3 h-3 text-white" 
                     fill="currentColor" 
                     viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
            
            <span class="block truncate font-normal"
                  [class.text-gray-400]="option.disabled">
              {{ option.label }}
            </span>
          </div>
          
          <!-- Check icon for single select -->
          <span *ngIf="!multiple && isSelected(option.value)" 
                class="absolute inset-y-0 right-0 flex items-center pr-4 text-primary">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
          </span>
        </div>
        
        <!-- No options message -->
        <div *ngIf="filteredOptions.length === 0" 
             class="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-400">
          <span class="block truncate font-normal">
            {{ searchTerm ? 'No se encontraron opciones' : 'No hay opciones disponibles' }}
          </span>
        </div>
      </div>
  
      <!-- Footer with selection count (Multiple mode) -->
      <div *ngIf="multiple && selectedValues.length > 0" 
           class="px-3 py-2 border-t border-gray-600 flex-shrink-0">
        <div class="text-xs text-gray-300">
          {{ selectedValues.length }} de {{ options.length }} seleccionados
        </div>
      </div>
    </div>
  </ng-template>